<?xml version="1.0" encoding="utf-8" ?>
<ROOT>

  <GetDevByStation db="SGAPP" type="sql" args="st,et,name" fields="pmsId,alertType,alertLevel">
    <![CDATA[ 
    SELECT DEV.COL12 AS PMSID ,R.MONITOR_TYPE,ALERT_LEVEL FROM YS_DB.YSH_SC_DEVICE AS DEV
    JOIN YS_DB.SENSOR_INFO_R AS R
    ON DEV.ID = R.DEVICE_ID
    LEFT JOIN (SELECT A.ID AS ID ,A.ALERT_TIME AS ALERT_TIME , A.DEVICE_ID AS DEVICE_ID ,A.MSG_TYPE,A.MSG_CONTENT,A.ALERT_LEVEL,A.ALERT_TYPE FROM YS_DB.YSH_ALERT_MSG AS A
        RIGHT JOIN (SELECT DEVICE_ID,max(ALERT_TIME) AS TIME,ALERT_TYPE FROM YS_DB.YSH_ALERT_MSG GROUP By DEVICE_ID,ALERT_TYPE ) AS B
        ON A.DEVICE_ID = B.DEVICE_ID AND A.ALERT_TIME = B.TIME AND A.ALERT_TYPE = B.ALERT_TYPE
        WHERE A.ALERT_TIME < {et} AND A.ALERT_TIME >= {st}) AS ALERT
    ON DEV.ID = AlERT.DEVICE_ID AND (R.MONITOR_TYPE = ALERT.ALERT_TYPE OR ALERT.ALERT_TYPE IS NULL)
    WHERE DEV.COL0 LIKE  '%{name}%'
    ]]>
  </GetDevByStation>
</ROOT>